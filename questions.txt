- How many flights in 2020

SELECT count(*)
FROM route_flights
WHERE start_ts >= '2020-01-01'
  AND start_ts < '2021-01-01'

- How many flights in 2020

### TODO
SELECT count(*)
FROM route_flights
WHERE start_ts >= now()
  AND start_ts < now() - INTERVAL '1 year'


- What aircraft have the most miles, least? Together?

SELECT max(tach_time) as tach_time
FROM aircraft

UNION

SELECT min(tach_time) as tach_time
FROM aircraft

- How many times has each FF# been used?

SELECT p.frequent_flyer_number, count(p.id)
FROM passengers p
WHERE p.frequent_flyer_number IS NOT NULL
GROUP BY p.frequent_flyer_number
ORDER BY count(p.id) DESC


- What passengers have flown the most (what if they have very similar names but not quite the same)?
    - Freq Fliers?

SELECT 
    p.first_name,
    p.last_name,
    count(p.id)
FROM passengers p
GROUP BY p.first_name, p.last_name
HAVING count(p.id) > 1
ORDER BY count(p.id) DESC


- What is the annual cost due to unsold seats?


- What Origin Destination combo sells the most?

    - Which Origin -> Dest sells out the soonest?


- What is the most sold seat?

SELECT count(sa.id), acs.number
FROM seat_assignments sa
LEFT JOIN aircraft_seat acs ON acs.id = sa.seat_id
GROUP BY acs.number
ORDER BY count(sa.id) DESC;


- What is the most unsold seat?

Can not just use least frequently sold seat because some seats may never get sold?
What is this question even asking? A40 on one plane is not A40 on another plane, 
because other planes may not even have A40.
Z100 is the most unsold seat in this case.

We need to look all aircraft, what is the least sold seat over all route flights.
Group By aircraft.
For all tickets, seat assignments, 

SELECT at.manufacturer, at.model, acs.number, count(sa.seat_id)
FROM tickets t
LEFT JOIN seat_assignments sa ON t.seat_assignment_id = sa.id
LEFT JOIN aircraft_seat acs ON sa.seat_id = acs.id
LEFT JOIN aircraft_types at ON acs.aircraft_type_id = at.id
GROUP BY at.manufacturer, at.model, acs.number;

SELECT at.manufacturer, at.model, acs.number, acs.type, acs.location, count(sa.seat_id)
FROM tickets t
LEFT JOIN seat_assignments sa ON t.seat_assignment_id = sa.id
LEFT JOIN aircraft_seat acs ON sa.seat_id = acs.id
LEFT JOIN aircraft_types at ON acs.aircraft_type_id = at.id
GROUP BY at.manufacturer, at.model, acs.number, acs.type, acs.location
ORDER BY count(sa.seat_id);


- What is the most unsold Orig -> Dest

SELECT count(rf.id)
FROM route_flights rf
LEFT JOIN aircraft a ON rf.aircraft_id = a.id
LEFT JOIN aircraft_types at ON a.type_id = at.id
LEFT JOIN aircraft_seat acs ON at.id = acs.aircraft_type_id
LEFT JOIN seat_assignments sa ON acs.id = sa.seat_id
postgres-# WHERE sa.id IS NOT NULL;

SELECT count(rf.id), sum(CASE WHEN sa.id IS NOT NULL THEN 1 ELSE 0 END) 
FROM route_flights rf
LEFT JOIN aircraft a ON rf.aircraft_id = a.id
LEFT JOIN aircraft_types at ON a.type_id = at.id
LEFT JOIN aircraft_seat acs ON at.id = acs.aircraft_type_id
LEFT JOIN seat_assignments sa ON acs.id = sa.seat_id
WHERE rf.id = sa.route_flight_id
AND rf.id = 2;

Doesn't work because the conditional at the bottom ensures we only collect
rows where a Seat Assignement exists.

SELECT
  count(sa.id) as sold,
  (SELECT count(acs2.id)
    FROM route_flights rf2
    LEFT JOIN aircraft a2 ON rf2.aircraft_id = a2.id
    LEFT JOIN aircraft_types at2 ON a2.type_id = at2.id
    LEFT JOIN aircraft_seat acs2 ON at2.id = acs2.aircraft_type_id
    WHERE rf2.id = rf.id) as total
FROM route_flights rf
LEFT JOIN aircraft a ON rf.aircraft_id = a.id
LEFT JOIN aircraft_types at ON a.type_id = at.id
LEFT JOIN aircraft_seat acs ON at.id = acs.aircraft_type_id
LEFT JOIN seat_assignments sa ON acs.id = sa.seat_id
WHERE rf.id = sa.route_flight_id
AND rf.id = 2
GROUP BY rf.id;

For all route flights

SELECT
  rf.id,
  count(sa.id) as sold,
  (SELECT count(acs2.id)
    FROM route_flights rf2
    LEFT JOIN aircraft a2 ON rf2.aircraft_id = a2.id
    LEFT JOIN aircraft_types at2 ON a2.type_id = at2.id
    LEFT JOIN aircraft_seat acs2 ON at2.id = acs2.aircraft_type_id
    WHERE rf2.id = rf.id) as total
FROM route_flights rf
LEFT JOIN aircraft a ON rf.aircraft_id = a.id
LEFT JOIN aircraft_types at ON a.type_id = at.id
LEFT JOIN aircraft_seat acs ON at.id = acs.aircraft_type_id
LEFT JOIN seat_assignments sa ON acs.id = sa.seat_id
WHERE rf.id = sa.route_flight_id
GROUP BY rf.id;

postgres=# SELECT
  div(count(sa.id), 
  (SELECT count(acs2.id)
    FROM route_flights rf2
    LEFT JOIN aircraft a2 ON rf2.aircraft_id = a2.id
    LEFT JOIN aircraft_types at2 ON a2.type_id = at2.id                                                                                                                                                                LEFT JOIN aircraft_types at2 ON a2.type_id = at2.id
    LEFT JOIN aircraft_seat acs2 ON at2.id = acs2.aircraft_type_id
    WHERE rf2.id = rf.id))
FROM route_flights rf
LEFT JOIN aircraft a ON rf.aircraft_id = a.id
LEFT JOIN aircraft_types at ON a.type_id = at.id
LEFT JOIN aircraft_seat acs ON at.id = acs.aircraft_type_id
LEFT JOIN seat_assignments sa ON acs.id = sa.seat_id
WHERE rf.id = sa.route_flight_id
AND rf.id = 2
GROUP BY rf.id;

WHY ZERO?

postgres=# SELECT rf.id,
  (count(sa.id)::decimal /
  (SELECT count(acs2.id)
    FROM route_flights rf2
    LEFT JOIN aircraft a2 ON rf2.aircraft_id = a2.id
    LEFT JOIN aircraft_types at2 ON a2.type_id = at2.id
    LEFT JOIN aircraft_seat acs2 ON at2.id = acs2.aircraft_type_id
    WHERE rf2.id = rf.id)::decimal) as frac_sold
FROM route_flights rf
LEFT JOIN aircraft a ON rf.aircraft_id = a.id
LEFT JOIN aircraft_types at ON a.type_id = at.id
LEFT JOIN aircraft_seat acs ON at.id = acs.aircraft_type_id
LEFT JOIN seat_assignments sa ON acs.id = sa.seat_id
WHERE rf.id = sa.route_flight_id
AND rf.id = 2
GROUP BY rf.id;

Show explain.  Add view with this select?



But how to get answer with single query?







- What seat is sold last most often?




- Highest cost flight




- Lowest Cost flight




- Highest Profit Flight




- Lowest Profit Flight




- What time of day are most planes in air




- What’s the average flight delay per flight?




- What’s the flight delay for different days of the week?





- What’s the average flight delay for Flight number XYZ1234 (Great subquery question)




- What flights to longer to complete that expected by duration?
    - Was it weather? Were seasons to blame?




- Where do vegans sit?



- How many fliers are frequent but do not have a frequent flier ID



- Percentage of people that do round trips



